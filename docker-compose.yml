version: '3.8'

# Docker Compose configuration for ECS deployment
# Note: This configuration uses RDS MySQL instead of a local MySQL container
# Make sure to set the following environment variables for RDS connection:
# - LOCAL_MYSQL_HOST (your RDS endpoint)
# - LOCAL_MYSQL_PORT (usually 3306)
# - LOCAL_MYSQL_USER (your RDS username)
# - LOCAL_MYSQL_PASSWORD (your RDS password)
# - LOCAL_MYSQL_DATABASE (your database name)

services:
  backend:
    build:
      context: .
      dockerfile: ./backend/Dockerfile
    ports:
      - "8001:8000"
    environment:
      # Core settings
      - ENVIRONMENT=production
      # RDS MySQL connection (set these via environment variables or .env file)
      - LOCAL_MYSQL_HOST=${LOCAL_MYSQL_HOST}
      - LOCAL_MYSQL_PORT=${LOCAL_MYSQL_PORT:-3306}
      - LOCAL_MYSQL_USER=${LOCAL_MYSQL_USER}
      - LOCAL_MYSQL_PASSWORD=${LOCAL_MYSQL_PASSWORD}
      - LOCAL_MYSQL_DATABASE=${LOCAL_MYSQL_DATABASE:-connectorMCP}
      # API keys (set via environment variables)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-myjwtsecret}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-YObEtwQKn42aYaLctHJUyYKmto1r18LfSMJaur_oKe4=}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - API_BASE_URL=${API_BASE_URL:-http://localhost:8001}
    # Production command (no reload)
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Backend API URL (set this to your ECS backend service URL)
        # This is baked into the build at build time
        VITE_API_URL: ${VITE_API_URL:-https://mosaic.apps.kaaylabs.com}
    ports:
      - "8080:80"
    restart: unless-stopped
    depends_on:
      - backend
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Note: No MySQL service - using AWS RDS MySQL
# Ensure your RDS instance is:
# 1. In the same VPC as your ECS tasks
# 2. Security group allows inbound connections from ECS tasks on port 3306
# 3. Database and user are created before deployment
